
/* Smart UI v20.0.64 (2024-10-28) 
Copyright (c) 2011-2024 jQWidgets. 
License: https://htmlelements.com/license/ */ //

Smart.Utilities.Assign("Grid.Export",class{exportData(e,t,o){const a=this,l=new Smart.Utilities.DataExporter({exportHeader:a.dataExport.header}),r=[];l.expandChar=a.dataExport.expandChar,l.collapseChar=a.dataExport.collapseChar,l.pageOrientation=a.dataExport.pageOrientation,l.style=a.dataExport.style,l.filterBy=a.dataExport.filterBy,l.groupBy=a.dataExport.groupBy,l.addImageToCell=a.dataExport.addImageToCell,l.headerContent=a.dataExport.headerContent,l.footerContent=a.dataExport.footerContent,l.setRowHeight=a.dataExport.setRowHeight,l.cellFormatFunction=a.dataExport.cellFormatFunction,l.freezeHeader=a.dataExport.freezeHeader,l.exportAsTable=a.dataExport.exportAsTable,l.onlySelected=a.dataExport.onlySelected;const n=a.columns.toArray().slice(0).filter((e=>!1!==e.allowExport));if(l.header={columns:n,columngroups:a.columnGroups.slice(0)},!a.dataExport.style){const t=window.getComputedStyle(a),o=window.getComputedStyle(a.columns.length>0&&a.columns[0].element?a.columns[0].element:a.$.columnHeader),n=window.getComputedStyle(a.$.columnHeader),i=e=>{const t=e.fontSize,o=e.borderRightColor,a=e.backgroundColor,l=e.color,r=new Array("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f");function n(e){return(e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))?"#"+i(e[1])+i(e[2])+i(e[3]).toUpperCase():"#ffffff"}function i(e){return isNaN(e)?"00":r[(e-e%16)/16]+r[e%16]}return{borderColor:n(o),fontSize:t,fontFamily:"Calibri",color:n(l),backgroundColor:n(a)}};if(0!==a.offsetWidth&&0!==a.offsetHeight){const d=i(t),c=i(o),s=i(n),p={height:a.$.columnHeader.offsetHeight+"px",border:"1px solid "+d.borderColor,fontFamily:s.fontFamily,fontSize:s.fontSize,color:s.color,backgroundColor:c.backgroundColor,fontWeight:"400"},f={border:"1px solid "+d.borderColor,fontFamily:d.fontFamily,fontSize:d.fontSize},u={height:a.layout.rowMinHeight+"px",verticalAlign:"center"};for(let t=0;t<a.columns.length;t++){const o=a.columns[t];if(!o.allowExport)continue;if(!o.visible)continue;p[o.dataField]={textAlign:o.align,verticalAlign:"center",width:o.computedWidth+"px",format:o.cellsFormat||""};let l=o.cellsFormat||"";l||("date"===o.dataType?l="d":"dateTime"===o.dataType?l="D":"time"===o.dataType&&(l="t")),a.locale&&l&&l.indexOf("c")>=0&&"xlsx"===e&&""!==a.locale&&"en"!==a.locale&&(l=a._getCurrencyByLocale(a.locale)+"x"+l);const n={textAlign:o.cellsAlign,format:l};if(f[o.dataField]=n,-1!==["html","jpeg","pdf","png","xlsx"].indexOf(e)&&(o.template||o.formatFunction))for(let e=0;e<a.rows.length;e++){const t=a.rows[e];let l=a.rows[e]["column_"+o.dataField];if(a.dataExport.viewStart&&e<a.dataExport.viewStart||a.dataExport.viewEnd&&e>a.dataExport.viewEnd)continue;if(!l||t&&t.element&&t.element.classList.contains("smart-hidden")){const e=a._rowElements[0];if(!e)continue;if(t.element=e,t.grid=a,t.render(),l=t["column_"+o.dataField],!l)continue}const d={};d.border=l.borderColor,d.background=l.background,d.color=l.color;const c=new Array("0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"),s=e=>isNaN(e)?"00":c[(e-e%16)/16]+c[e%16],p=e=>e.startsWith("#")?e.length<6?e.toUpperCase()+e.substring(1):e.toUpperCase():(e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))?"#"+s(e[1])+s(e[2])+s(e[3]).toUpperCase():null;if(l.className&&l.element){const e=i(window.getComputedStyle(l.element));d.border="1px solid "+p(e.borderColor),d.backgroundColor=p(e.background),d.color=p(e.color)}else if(o.formatFunction){const e={row:t.id,column:o.dataField,value:l.value,cell:l};o.formatFunction(e),e.cell.borderColor&&(d.border="1px solid "+p(e.cell.borderColor)),e.cell.background&&(d.backgroundColor=p(e.cell.background)),e.cell.color&&(d.color=p(e.cell.color))}const f=void 0!==a.dataExport.viewStart?e-a.dataExport.viewStart:e;r[e]=Object.assign({},t.data),r[e][o.dataField]=l.element.textContent,n[f]=d}}a.appearance.alternationCount>0&&(u.alternationCount=a.appearance.alternationCount,u.alternationStart=a.appearance.alternationStart,u.alternationEnd=a.appearance.alternationEnd,u.alternationIndex0Color=d.color,u.alternationIndex0BackgroundColor=d.backgroundColor,u.alternationIndex1Color=d.color,u.alternationIndex1BackgroundColor="#F5F5F5"),l.style={border:"1px solid "+d.borderColor,borderCollapse:"collapse",header:p,columns:f,rows:u}}}let i=!1;const d=!a.rowHierarchy||a.grouping.enabled?a.rows.toArray():a.rowHierarchy,c=a.dataExport.rowIds,s=null!==c;let p=[];if(a.dataExport.view)a._recyclingRows.forEach(((e,t)=>{if(a.dataExport.viewStart&&t<a.dataExport.viewStart||a.dataExport.viewEnd&&t>a.dataExport.viewEnd)return!0;r[t]?p.push(r[t]):p.push(e.data)}));else{for(let t=0;t<d.length;t++){const o=d[t];if(o.visible&&(!1!==o.filtered||void 0===o.filtered)){if(s&&-1===c.indexOf(o.id))continue;const t={};for(let l=0;l<a.columns.length;l++){const r=a.columns[l];if(!r.allowExport)continue;const n=r.dataField;let d=o.data[n];if("taskChecklist"===n)if(d){const e=d.map((e=>{let t=e.text;return e.completed?t="âœ“ "+t:t+="X "+t,t}));d=e.toString()}else d="";if("taskUserId"===n){const e=a.users.find((e=>e.id===parseInt(d)||parseInt(e.id)===parseInt(d)));e&&(d=e.name)}if(void 0===d)if("createdBy"===r.template){const e=a.users.find((e=>e.id===o.createdBy));if(e){const o=e,a="string"==typeof o?o:o.name;t[n]=a}else t[n]=""}else if("createdTime"===r.template){const e=o.getCell(n).getFormattedValue(o.createdTime,"d")+"  "+o.getCell(n).getFormattedValue(o.createdTime,"t");t[n]=e}else if("modifiedBy"===r.template){const e=a.users.find((e=>e.id===o.modifiedBy));if(e){const o=e,a="string"==typeof o?o:o.name;t[n]=a}else t[n]=""}else if("modifiedTime"===r.template){const e=o.getCell(n).getFormattedValue(o.modifiedTime,"d")+"  "+o.getCell(n).getFormattedValue(o.modifiedTime,"t");t[n]=e}else t[n]="";else if(d&&d.indexOf&&(d.indexOf("{")>=0||"[]"===d)){const e=d.indexOf("{")>=0||"[]"===d?JSON.parse(d):d.split(", "),o=[];for(let t=0;t<e.length;t++)if("string"==typeof e[t])o.push(e[t]);else{if("image"===r.template){i=!0,o.push(e[t].value);continue}o.push(e[t].label)}t[n]=o.join(",")}else if(d&&d.indexOf&&"image"===r.template){const e=d.indexOf("{")>=0||"[]"===d?JSON.parse(d):d.split(","),o=[];i=!0;for(let t=0;t<e.length;t++)"string"==typeof e[t]?o.push(e[t]):(o.push(e[t].value),o.push(e[t].label));t[n]=o.join(",")}else if("csv"===e||"tsv"===e)if(r.cellsFormat){const e=o.getCell(n).getFormattedValue(d,r.cellsFormat);t[n]=e}else t[n]=d;else t[n]=d}p.push(t)}}d!==a.rowHierarchy||s||(p=a.dataSource.boundHierarchy,l.hierarchical=!0)}if(!a.dataExport.groupBy&&a.grouping.enabled&&a.dataSource&&a.dataSource.groupBy&&(l.groupBy=a.dataSource.groupBy&&a.dataSource.groupBy.toArray?a.dataSource.groupBy.toArray():null),a.dataExport.onlySelected&&a.selection.enabled)if(a.selection.allowCellSelection){const e=a.getSelectedCells(),t=[],o=[],r=[];for(let l=0;l<e.length;l++){const n=e[l],i=n[0],d=n[1],c=p[i][d];r[d]||o.push(a.columnByDataField[d]),r[d]=!0,t[i]||(t[i]={}),t[i][d]||(t[i][d]=c)}o.sort(((e,t)=>e<t?-1:e>t?1:0));for(let e in t){const a=t[e];for(let e=0;e<o.length;e++){const t=o[e];void 0===a[t.dataField]&&(a[t.dataField]="")}}l.header={columns:[...o]},p=Object.values(t)}else{const e=a.getSelectedRowIds(),t=[];for(let o=0;o<e.length;o++){const a=e[o];t.push(p[a])}p=t}if(a.checkLicense(!0),o){const t=o(p,l,e);t&&(p=t)}if(a.dataExport.cellFormatFunction)for(let e=0;e<p.length;e++){const t=p[e];for(let o=0;o<a.columns.length;o++){const l=a.columns[o];if(!l.allowExport)continue;const r=l.dataField;let n=t[r];const i=a.dataExport.cellFormatFunction(e,r,n);i&&(t[r]=i)}}if(!a.dataExport.addImageToCell&&i){const o=async e=>{const t=await fetch(e),o=await t.blob();return new Promise(((e,t)=>{const a=new FileReader;a.readAsDataURL(o),a.onloadend=()=>{const t=a.result;e(t)},a.onerror=t}))};let r=0,i=0;const d=()=>{l.addImageToCell=(e,t,o,l)=>{if("image"===a.columnByDataField[t].template)return{image:{id:"myImage"+e,base64:o,imageType:"jpeg",width:20,height:11,position:{offsetX:10+25*l.indexOf(o),offsetY:5.5}},value:o}},l.exportData(p,e,a.dataExport.fileName,t),a.dataExport.view&&a._recycle(!1)},c=p.length;for(let e=0;e<p.length;e++){const t=p[e];for(let a=0;a<n.length;a++){const l=n[a];if("image"===l.template){let a=t[l.dataField],n=[];n=a.indexOf(",")>=0?a.split(","):[a],t[l.dataField]=n,r+=n.length;for(let t=0;t<n.length;t++){const a=n[t];a.indexOf("data:image")>=0?i++:o(a).then((o=>{n[t]=o,i++,i===r&&e===c-1&&d()}))}}}}return}if(!p.length)return[];const f=l.exportData(p,e,a.dataExport.fileName,t);return a.dataExport.view&&a._recycle(!1),f}print(){const e=this,t=e.dataExport.fileName;e.dataExport.fileName=null;const o=e.exportData("html"),a=window.open("","","width=800,height=500"),l=a.document.open(),r='<!DOCTYPE html><html><head><meta charset="utf-8" /><title>'+t+"</title></head><body>"+o+"</body></html>";try{l.write(r),l.close(),setTimeout((function(){a.print(),a.close()}),100)}catch(e){}e.dataExport.fileName=t}});